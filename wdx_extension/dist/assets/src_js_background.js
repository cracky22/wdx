import{A as a}from"./src_js_constants.js";chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"save_source",title:"In wdx speichern",contexts:["page"]}),chrome.contextMenus.create({id:"save_text",title:"Textauswahl speichern",contexts:["selection"]}),chrome.alarms.create("retryQueue",{periodInMinutes:5})});chrome.runtime.onStartup.addListener(()=>{s()});chrome.runtime.onMessage.addListener((e,n,t)=>{e.type==="QUEUE_SAVE"?c(e.payload):e.type==="PROCESS_QUEUE"&&s()});async function c(e){if(!e)return;let t=(await chrome.storage.local.get("offlineQueue")).offlineQueue||[];t.some(r=>r.url===e.url&&r.text===e.text)||(t.push(e),await chrome.storage.local.set({offlineQueue:t}))}chrome.alarms.onAlarm.addListener(e=>{e.name==="retryQueue"&&s()});async function s(){let n=(await chrome.storage.local.get("offlineQueue")).offlineQueue||[];if(n.length===0)return;const t=[];let o=0;for(const r of n)try{if(!(await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).ok)throw new Error;o++}catch{t.push(r)}await chrome.storage.local.set({offlineQueue:t}),o>0&&i("Offline-Warteschlange",`${o} Elemente nachsynchronisiert.`)}chrome.contextMenus.onClicked.addListener(async(e,n)=>{const t={url:n.url,title:n.title||"Kein Titel",text:e.selectionText?e.selectionText.trim():"",keywords:""};try{if(!(await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).ok)throw new Error("Server Error");i("Erfolg","Gespeichert!")}catch{(await chrome.storage.local.get("wdx-exp-offline-queue"))["wdx-exp-offline-queue"]==="true"?(await c(t),i("Offline","In Warteschlange gespeichert.")):i("Fehler","Server nicht erreichbar.")}});async function i(e,n){(await chrome.storage.local.get("wdx-notifications"))["wdx-notifications"]!=="false"&&chrome.notifications.create({type:"basic",iconUrl:"../img/icon512.png",title:`wdx: ${e}`,message:n})}
