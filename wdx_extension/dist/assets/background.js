import{a as s}from"./constants.js";chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"save_source",title:"In wdx speichern",contexts:["page"]}),chrome.contextMenus.create({id:"save_text",title:"Textauswahl speichern",contexts:["selection"]})});chrome.runtime.onMessage.addListener((e,o,t)=>{e.type==="QUEUE_SAVE"&&a(e.payload)});async function a(e){const t=(await chrome.storage.local.get("offlineQueue")).offlineQueue||[];e&&(t.push(e),await chrome.storage.local.set({offlineQueue:t}))}chrome.alarms.create("retryQueue",{periodInMinutes:5});chrome.alarms.onAlarm.addListener(async e=>{if(e.name==="retryQueue"){let t=(await chrome.storage.local.get("offlineQueue")).offlineQueue||[];if(t.length===0)return;const n=[];for(const i of t)try{if(!(await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).ok)throw new Error}catch{n.push(i)}await chrome.storage.local.set({offlineQueue:n})}});chrome.contextMenus.onClicked.addListener(async(e,o)=>{const t={url:o.url,title:o.title||"Kein Titel",text:e.selectionText?e.selectionText.trim():"",keywords:""};try{if(!(await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).ok)throw new Error("Server Error");r("Erfolg","Gespeichert!")}catch{localStorage.getItem("wdx-exp-offline-queue")==="true"?(a(t),r("Offline","In Warteschlange gespeichert.")):r("Fehler","Verbindung fehlgeschlagen.")}});function r(e,o){localStorage.getItem("wdx-notifications")==="true"&&chrome.notifications.create({type:"basic",iconUrl:"../img/icon512.png",title:`wdx: ${e}`,message:o})}
