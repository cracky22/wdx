import{a as c}from"./constants.js";chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"save_source",title:"In wdx speichern",contexts:["page"]}),chrome.contextMenus.create({id:"save_text",title:"Textauswahl speichern",contexts:["selection"]}),chrome.alarms.create("retryQueue",{periodInMinutes:5})});chrome.runtime.onStartup.addListener(()=>{a()});chrome.runtime.onMessage.addListener((e,t,o)=>{e.type==="QUEUE_SAVE"&&s(e.payload)});async function s(e){if(!e)return;const o=(await chrome.storage.local.get("offlineQueue")).offlineQueue||[];o.push(e),await chrome.storage.local.set({offlineQueue:o})}chrome.alarms.onAlarm.addListener(e=>{e.name==="retryQueue"&&a()});async function a(){let t=(await chrome.storage.local.get("offlineQueue")).offlineQueue||[];if(t.length===0)return;const o=[];let n=0;for(const i of t)try{if(!(await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).ok)throw new Error;n++}catch{o.push(i)}await chrome.storage.local.set({offlineQueue:o}),n>0&&r("Sync",`${n} Elemente nachsynchronisiert.`)}chrome.contextMenus.onClicked.addListener(async(e,t)=>{const o={url:t.url,title:t.title||"Kein Titel",text:e.selectionText?e.selectionText.trim():"",keywords:""};try{if(!(await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).ok)throw new Error("Server Error");r("Erfolg","Gespeichert!")}catch{s(o),r("Offline","In Warteschlange gespeichert.")}});function r(e,t){try{localStorage.getItem("wdx-notifications")==="true"&&chrome.notifications.create({type:"basic",iconUrl:"../img/icon512.png",title:`wdx: ${e}`,message:t})}catch{chrome.notifications.create({type:"basic",iconUrl:"../img/icon512.png",title:`wdx: ${e}`,message:t})}}
